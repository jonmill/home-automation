@namespace HomeAutomation.Web.Components.Pages

@page "/"
@using HomeAutomation.Database
@using HomeAutomation.Models.Database
@using HomeAutomation.Web.Services
@using LinqToDB.Async
@using MQTTnet.Packets

<PageTitle>Dashboard</PageTitle>
<MudStack>
    @if (_isRefreshing)
    {
        <MudProgressCircular Indeterminate Color="Color.Primary" Size="Size.Large" />
    }
    <MudText Typo="Typo.h3" Style="margin: 20px 0px 0px 20px;">Nora's Room</MudText>
    <MudGrid Style="margin-left: 20px" Spacing="10" Justify="Justify.FlexStart">
        <MudItem>
            <MudPaper Style="@($"padding: 12px; background: {NoraRoom.TemperatureStyle}; color: black")">
                <MudText><strong>Temperature</strong></MudText>
                <MudText Typo="Typo.body2">
                    @NoraRoom.TemperatureString
                </MudText>
                <MudSpacer />
                <MudText Typo="Typo.subtitle2" Style="margin-top: 10px;">
                    @NoraRoom.TemperatureLastMeasurement
                </MudText>
            </MudPaper>
        </MudItem>
        <MudItem>
            <MudPaper Style="@($"padding: 12px; background: {NoraRoom.HumidityStyle}; color: black")">
                <MudText><strong>Humidity</strong></MudText>
                <MudText Typo="Typo.body2">
                    @NoraRoom.HumidityString
                </MudText>
                <MudSpacer />
                <MudText Typo="Typo.subtitle2" Style="margin-top: 10px;">
                    @NoraRoom.HumidityLastMeasurement
                </MudText>
            </MudPaper>
        </MudItem>
        <MudItem>
            <MudPaper Style="@($"padding: 12px; background: {NoraRoom.PressureStyle}; color: black")">
                <MudText><strong>Pressure</strong></MudText>
                <MudText Typo="Typo.body2">
                    @NoraRoom.PressureString
                </MudText>
                <MudSpacer />
                <MudText Typo="Typo.subtitle2" Style="margin-top: 10px;">
                    @NoraRoom.PressureLastMeasurement
                </MudText>
            </MudPaper>
        </MudItem>
        <MudItem>
            <MudPaper Style="@($"padding: 12px; background: {NoraRoom.AQIStyle}; color: black")">
                <MudText><strong>AQI</strong></MudText>
                <MudText Typo="Typo.body2">
                    @NoraRoom.AQIString
                </MudText>
                <MudSpacer />
                <MudText Typo="Typo.subtitle2" Style="margin-top: 10px;">
                    @NoraRoom.AQILastMeasurement
                </MudText>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudSpacer />
    <MudText Typo="Typo.h3" Style="margin: 0px 0px 0px 20px;">Outside</MudText>
    <MudGrid Style="margin-left: 20px" Spacing="10" Justify="Justify.FlexStart">
        <MudItem>
            <MudPaper Style="@($"padding: 12px; background: {Outside.TemperatureStyle}; color: black")">
                <MudText><strong>Temperature</strong></MudText>
                <MudText Typo="Typo.body2">
                    @Outside.TemperatureString
                </MudText>
                <MudSpacer />
                <MudText Typo="Typo.subtitle2" Style="margin-top: 10px;">
                    @Outside.TemperatureLastMeasurement
                </MudText>
            </MudPaper>
        </MudItem>
        <MudItem>
            <MudPaper Style="@($"padding: 12px; background: {Outside.HumidityStyle}; color: black")">
                <MudText><strong>Humidity</strong></MudText>
                <MudText Typo="Typo.body2">
                    @Outside.HumidityString
                </MudText>
                <MudSpacer />
                <MudText Typo="Typo.subtitle2" Style="margin-top: 10px;">
                    @Outside.HumidityLastMeasurement
                </MudText>
            </MudPaper>
        </MudItem>
        <MudItem>
            <MudPaper Style="@($"padding: 12px; background: {Outside.PressureStyle}; color: black")">
                <MudText><strong>Pressure</strong></MudText>
                <MudText Typo="Typo.body2">
                    @Outside.PressureString
                </MudText>
                <MudSpacer />
                <MudText Typo="Typo.subtitle2" Style="margin-top: 10px;">
                    @Outside.PressureLastMeasurement
                </MudText>
            </MudPaper>
        </MudItem>
        <MudItem>
            <MudPaper Style="@($"padding: 12px; background: {Outside.AQIStyle}; color: black")">
                <MudText><strong>AQI</strong></MudText>
                <MudText Typo="Typo.body2">
                    @Outside.AQIString
                </MudText>
                <MudSpacer />
                <MudText Typo="Typo.subtitle2" Style="margin-top: 10px;">
                    @Outside.AQILastMeasurement
                </MudText>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudSpacer />
    <MudText Typo="Typo.h3" Style="margin: 0px 0px 0px 20px;">Security</MudText>
    <MudGrid Style="margin-left: 20px" Spacing="10" Justify="Justify.FlexStart">
        <MudItem>
            <MudPaper Style="@($"padding: 12px; background: {FrontDoor.SecurityStyle}; color: black")">
                <MudText><strong>Front Door</strong></MudText>
                <MudText Typo="Typo.body2">
                    @FrontDoor.SecurityText
                </MudText>
            </MudPaper>
        </MudItem>
        <MudItem>
            <MudPaper Style="@($"padding: 12px; background: {LivingRoom1.SecurityStyle}; color: black")">
                <MudText><strong>Living Room 1</strong></MudText>
                <MudText Typo="Typo.body2">
                    @LivingRoom1.SecurityText
                </MudText>
            </MudPaper>
        </MudItem>
        <MudItem>
            <MudPaper Style="@($"padding: 12px; background: {LivingRoom2.SecurityStyle}; color: black")">
                <MudText><strong>Living Room 2</strong></MudText>
                <MudText Typo="Typo.body2">
                    @LivingRoom2.SecurityText
                </MudText>
            </MudPaper>
        </MudItem>
        <MudItem>
            <MudPaper Style="@($"padding: 12px; background: {DiningRoom.SecurityStyle}; color: black")">
                <MudText><strong>Dining Room</strong></MudText>
                <MudText Typo="Typo.body2">
                    @DiningRoom.SecurityText
                </MudText>
            </MudPaper>
        </MudItem>
        <MudItem>
            <MudPaper Style="@($"padding: 12px; background: {TVRoom.SecurityStyle}; color: black")">
                <MudText><strong>TV Room</strong></MudText>
                <MudText Typo="Typo.body2">
                    @TVRoom.SecurityText
                </MudText>
            </MudPaper>
        </MudItem>
        <MudItem>
            <MudPaper Style="@($"padding: 12px; background: {GarageDoor.SecurityStyle}; color: black")">
                <MudText><strong>Garage Door</strong></MudText>
                <MudText Typo="Typo.body2">
                    @GarageDoor.SecurityText
                </MudText>
            </MudPaper>
        </MudItem>
    </MudGrid>

    <MudSpacer />
    <MudText Typo="Typo.h3" Style="margin: 0px 0px 0px 20px;">System Status</MudText>
    <MudGrid Style="margin-left: 20px" Spacing="10" Justify="Justify.FlexStart">
        <MudItem>
            <MudPaper Style="@($"padding: 12px; background: {WeatherStationHeartbeat.HeartbeatStyle}; color: black")">
                <MudText><strong>Weather Station</strong></MudText>
                <MudText Typo="Typo.body2">
                    @WeatherStationHeartbeat.HeartbeatText
                </MudText>
            </MudPaper>
        </MudItem>
        <MudItem>
            <MudPaper Style="@($"padding: 12px; background: {NoraRoomHeartbeat.HeartbeatStyle}; color: black")">
                <MudText><strong>Nora Room</strong></MudText>
                <MudText Typo="Typo.body2">
                    @NoraRoomHeartbeat.HeartbeatText
                </MudText>
            </MudPaper>
        </MudItem>
        <MudItem>
            <MudPaper Style="@($"padding: 12px; background: {SecuritySystemHeartbeat.HeartbeatStyle}; color: black")">
                <MudText><strong>Security System</strong></MudText>
                <MudText Typo="Typo.body2">
                    @SecuritySystemHeartbeat.HeartbeatText
                </MudText>
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudStack>

@code {
    private EnvironmentData Outside = new();
    private EnvironmentData NoraRoom = new();
    private SecurityData FrontDoor = new(null);
    private SecurityData LivingRoom1 = new(null);
    private SecurityData LivingRoom2 = new(null);
    private SecurityData DiningRoom = new(null);
    private SecurityData TVRoom = new(null);
    private SecurityData GarageDoor = new(null);
    private HeartbeatData WeatherStationHeartbeat = new();
    private HeartbeatData NoraRoomHeartbeat = new();
    private HeartbeatData SecuritySystemHeartbeat = new();

    [Inject]
    private IServiceScopeFactory ServiceScopeFactory { get; set; } = null!;

    [Inject]
    private ThemeService ThemeService { get; set; } = null!;

    private Timer _refreshTimer = null!;
    private bool _isRefreshing = false;

    protected override async Task OnInitializedAsync()
    {
        await RefreshDataAsync();
        _refreshTimer = new Timer(OnTimerCallback, null, TimeSpan.Zero, TimeSpan.FromMinutes(1));
    }

    private void OnTimerCallback(object? state)
    {
        RefreshDataAsync().GetAwaiter().GetResult();
    }

    private async Task RefreshDataAsync()
    {
        _isRefreshing = true;
        using IServiceScope scope = ServiceScopeFactory.CreateScope();
        using HomeAutomationDb dbContext = scope.ServiceProvider.GetRequiredService<HomeAutomationDb>();
        await RefreshEnvironmentalDataAsync(dbContext);
        await RefreshSecurityDataAsync(dbContext);
        await RefreshHeartbeatDataAsync(dbContext);
        _isRefreshing = false;
        await InvokeAsync(() => StateHasChanged());
    }

    private async Task RefreshEnvironmentalDataAsync(HomeAutomationDb dbContext)
    {
        SensorValue? outsideTemp = await dbContext.SensorValues.Where(sv => sv.SensorSerialNumber == "17").OrderByDescending(sv
        => sv.Timestamp).FirstOrDefaultAsync();
        SensorValue? outsideHumidity = await dbContext.SensorValues.Where(sv => sv.SensorSerialNumber ==
        "18").OrderByDescending(sv => sv.Timestamp).FirstOrDefaultAsync();
        SensorValue? outsidePressure = await dbContext.SensorValues.Where(sv => sv.SensorSerialNumber ==
        "19").OrderByDescending(sv => sv.Timestamp).FirstOrDefaultAsync();
        SensorValue? noraRoomAQI = await dbContext.SensorValues.Where(sv => sv.SensorSerialNumber == "13").OrderByDescending(sv
        => sv.Timestamp).FirstOrDefaultAsync();
        SensorValue? noraRoomTemp = await dbContext.SensorValues.Where(sv => sv.SensorSerialNumber == "14").OrderByDescending(sv
        => sv.Timestamp).FirstOrDefaultAsync();
        SensorValue? noraRoomPressure = await dbContext.SensorValues.Where(sv => sv.SensorSerialNumber ==
        "15").OrderByDescending(sv => sv.Timestamp).FirstOrDefaultAsync();
        SensorValue? noraRoomHumidity = await dbContext.SensorValues.Where(sv => sv.SensorSerialNumber ==
        "16").OrderByDescending(sv => sv.Timestamp).FirstOrDefaultAsync();
        NoraRoom = new EnvironmentData(noraRoomTemp, noraRoomHumidity, noraRoomPressure, noraRoomAQI);
        Outside = new EnvironmentData(outsideTemp, outsideHumidity, outsidePressure, null);
    }

    private async Task RefreshSecurityDataAsync(HomeAutomationDb dbContext)
    {
        SensorValue? frontDoor = await dbContext.SensorValues.Where(sv => sv.SensorSerialNumber == "1").OrderByDescending(sv => sv.Timestamp).FirstOrDefaultAsync();
        SensorValue? garageDoor = await dbContext.SensorValues.Where(sv => sv.SensorSerialNumber == "2").OrderByDescending(sv => sv.Timestamp).FirstOrDefaultAsync();
        SensorValue? diningRoom = await dbContext.SensorValues.Where(sv => sv.SensorSerialNumber == "3").OrderByDescending(sv => sv.Timestamp).FirstOrDefaultAsync();
        SensorValue? livingRoom1 = await dbContext.SensorValues.Where(sv => sv.SensorSerialNumber == "4").OrderByDescending(sv => sv.Timestamp).FirstOrDefaultAsync();
        SensorValue? livingRoom2 = await dbContext.SensorValues.Where(sv => sv.SensorSerialNumber == "5").OrderByDescending(sv => sv.Timestamp).FirstOrDefaultAsync();
        SensorValue? tvRoom = await dbContext.SensorValues.Where(sv => sv.SensorSerialNumber == "6").OrderByDescending(sv => sv.Timestamp).FirstOrDefaultAsync();
        FrontDoor = new SecurityData(frontDoor);
        LivingRoom1 = new SecurityData(livingRoom1);
        LivingRoom2 = new SecurityData(livingRoom2);
        DiningRoom = new SecurityData(diningRoom);
        TVRoom = new SecurityData(tvRoom);
        GarageDoor = new SecurityData(garageDoor);
    }

    private async Task RefreshHeartbeatDataAsync(HomeAutomationDb dbContext)
    {
        Heartbeat? weatherHeartbeat = await dbContext.Heartbeats.Where(hb => hb.BoardSerialNumber == "4").OrderByDescending(hb => hb.Timestamp).FirstOrDefaultAsync();
        Heartbeat? noraRoomHeartbeat = await dbContext.Heartbeats.Where(hb => hb.BoardSerialNumber == "6").OrderByDescending(hb => hb.Timestamp).FirstOrDefaultAsync();
        Heartbeat? securityHeartbeat = await dbContext.Heartbeats.Where(hb => hb.BoardSerialNumber == "1").OrderByDescending(hb => hb.Timestamp).FirstOrDefaultAsync();
        WeatherStationHeartbeat = new HeartbeatData(weatherHeartbeat);
        NoraRoomHeartbeat = new HeartbeatData(noraRoomHeartbeat);
        SecuritySystemHeartbeat = new HeartbeatData(securityHeartbeat);
    }
}